# linux基础深入理解（从零到一）

## 1.线程和进程

### 1.1 进程简介 
    进程是处理器执行的一个实例，可使用任意资源以便linux内核来处理完成该进程任务，进程一般由程序，数据集合和进程控制块三部分组成

----进程在Linux系统当中也拥有一套完整的数据结构(task_struct)，用来保存进程运行期间所要用到的信息，又称进程描述符
1. state  进程状态
1. thread_info  进程信息
1. pid  进程id 
1. signal  信号信息
1. ...

### 1.2 进程的生命周期   
- **进程的创建和销毁过程**
![进程创建和销毁](https://xymbucket.oss-cn-beijing.aliyuncs.com/blogs/Images/20211122164337.png)

   1. fork()系统调用，父进程获得一个新建进程（子进程）的进程描述符，同时复制父进程的进程描述符给子进程，两个进程共享同一块地址空间
   1. exec()系统调用，由于父子进程共享用一个地址空间，当写数据时会产生页错误，这时内核会给子进程分配新的物理页，将子进程程序复制到子进程对应的地址空间
   1. 当子进程程序执行完成之后调用，通过系统调用exit()终止子进程，这时将会给父进程发送终止信号，并释放大部分数据结构，这个时候进程称为僵尸进程

- **进程的基本状态转换**
![进程基本状态转换](https://xymbucket.oss-cn-beijing.aliyuncs.com/blogs/Images/20211122174158.png)

    5种基本状态中需要注意的是：
    新建状态：该状态下系统已给进程分配PCB(进程控制块)，，但进程所需资源尚未分配，进程还未进入主存，可以认为创建工作还未完成
    终止状态：进程正常执行结束和异常终止都可能导致进程转变终止状态，终止状态进程不能再执行，但在操作系统中会保留记录，供其他进程收集、

### 1.3 进程优先级及上下文切换

**进程优先级**
本质是一个数字，用来确定cpu处理进程的顺序，在linux当中可分为实时优先级（0-99）和非实时优先级（100-139）两种，如果系统存在实时进程，就优先执行，非实时进程则要等实时进程退出或主动让出cpu才能被调度执行，非实时进程的优先级可以通过调整nice级别对优先级进行调整

>既然进程优先级是被用来影响cpu对进程调度的存在，那么在进程调度过程就存在进程之间的  => *上下文切换*

**上下文切换**
先看看上下文代表什么：在处理器执行期间，被执行的进程信息存储在寄存器和高速缓存当中，这些被加载到寄存器的进程信息数据集就称为上下文  
那么进程切换时，恢复的进程信息被加载到寄存器当中，挂起进程的上下文信息就会存储在进程描述符和内核模式堆栈区域内，每次上下文切换都需要刷新寄存器和高速缓存，所以上下文切换会影响性能

>除了正常的进程调度会产生进程的上下文切换之外，还有系统调用过程中也会产生上下文的切换，内核帮我们管理了所有的硬件资源，当上层应用对这部分资源的调用的时候，就会发生系统调用（执行操作系统预留的接口），也就是中断处理，目的是实现任务的快速响应

**中断处理**
- 硬中断：由硬件设备产生，需要快速响应（磁盘I/O中断、键盘中断、鼠标中断...）
- 软中断:用来处理可以推迟的任务（TCP/IP操作，SCSI协议 = 数据传输协议）
*中断操作会引起产生上下文切换，这势必会导致性能下降，尤其在多处理器环境下，中断是由每个处理器处理，这时将中断绑定单个处理器可以有效提升系统性能*

***

>注：特殊进程之孤儿进程 + 僵尸进程 + 守护进程
> 1. 孤儿进程:子进程运行期间父进程退出，这部分子进程称为孤儿进程，将会被init进程收并记录其状态，孤儿进程不会对系统造成危害
> 1. 僵尸进程：通过fork()调用产生的子进程，子进程运行结束exit()之后，父进程未调用wait()获取子进程信息，这时的子进程的进程描述符信息仍然保存在系统之中，占用进程号，此类进程称为僵尸进程
> 1. 守护线程：Linux Daemon（守护进程）是运行在后台的一种特殊进程。它独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件，例如syslogd、 web服务器httpd和数据库服务器mysqld等


### 1.4 线程简介

线程是进程内的产生的一个执行单元，不同的线程共享同一进程资源，如内存、地址空间等，线程也称为轻量级进程，因为它们共享公共资源，所以多线程会存在线程安全问题，这时需要在应用程序中实现互斥、锁和序列化等机制

    一个标准的线程的组成---线程ID+指令指针PC+寄存器+堆栈组

### 1.5 进程和线程的区别

- 进程是操作系统资源分配的最小单位，而线程是程序执行的最小单位
- 不同进程之间相互独立，而同一进程下的不同线程共享程序的内存空间
- 进程之间的上下文切换要比线程的切换慢很多

![进程线程区别图](https://xymbucket.oss-cn-beijing.aliyuncs.com/blogs/Images/20211123114400.png)

>为什么说线程是轻量级进程？怎么会产生线程这个概念呢？

早期的操作系统不存在线程这个概念，当时进程既是资源分配的最小单位也是程序运行的最小单位，以时间片分配的方式调度各个进程任务（这个调度可以是抢占或是轮转），进程就是任务调度的最小单位，但是进程之间的上下文切换对资源的消耗比较大，以及对计算越来越高的性能和其他方面的需求，为了提升执行性能，这就产生了线程，线程就是程序在执行过程中控制其单一顺序执行的程序执行流，是程序的最小执行单元。



